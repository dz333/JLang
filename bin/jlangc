#!/bin/sh

prg=`basename "$0"`
dir=`dirname "$0"`/..

usage() {
  polyglot -h
  cat <<EOF
  -j <jvm-options>         pass options to the Java VM
  -J <jvm>                 use a different Java VM (default java in path)
  -V                       echo the java command
EOF
}

fixpath() {
  windows=0

  if [ `uname | grep -c CYGWIN` -ne 0 ]; then
    windows=1
  fi

  cp="$1"
  if [ "$windows" = 1 ]; then
      cygpath -pw "$cp"
  else
      echo "$cp"
  fi
}

extra_cp=
extra_compiler_cp=
args=
vmargs=
java=java
ext=jlang

while true; do
    case "$1" in
        "")
            break
            ;;
        -V)
            verbose=1
            shift
            ;;
        -classpath)
            shift
            extra_cp="$extra_cp:$1"
            shift
            ;;
        -compiler-classpath)
            shift
            extra_compiler_cp="$extra_compiler_cp:$1"
            shift
            ;;        
        -j)
            shift
            vmargs="$vmargs '$1'"
            shift
            ;;
        -J)
            shift
            java="'$1'"
            shift
            ;;
        -h)
            usage=1
            break
            ;;
        *)
            args="$args '$1'"
            shift
            ;;
    esac
done

compiler_classpath="$dir/compiler/classes:$dir/lib/polyglot/lib/java_cup.jar:$dir/lib/polyglot/lib/polyglot.jar:$dir/lib/llvm.jar:$dir/lib/javacpp.jar:$extra_compiler_cp:$dir/lib/llvm-macosx-x86_64.jar:$dir/lib/llvm-linux-x86_64.jar"
runtime_classpath="$dir/runtime/out/classes"
runtime_classpath="$runtime_classpath:$extra_cp"

command="$java -ea $vmargs -classpath \"$(fixpath ${compiler_classpath})\" \
jlang.Main \
-classpath \"$(fixpath ${runtime_classpath})\" \
$args"

if [ "$usage" = 1 ]; then
  usage
  exit 0
fi

if [ "$verbose" = 1 ]; then
  echo "$command"
fi

eval $command
